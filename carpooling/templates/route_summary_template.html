{% extends 'bases/carrd_base.html' %}


{% block title %}Carpools for Event {% endblock %}

{% block styles %}
<style>
    #detailsdiv {
        display: block;
        position: absolute;
        top: 20%;
        left: 70%;
        width: 20%;
        height: inherit;
        background-color: #444;
        border-radius: 3%;
        box-shadow: 0px 0px 5px 0px rgba(255, 225, 225, 0.75);
        padding: 10px;
        margin: 10px;
        z-index: 1;
    }

    .hiddendetails {
        display: none;
    }

    .visibledetails:hover {
        background-color: #666;
        transition: cubic-bezier(0.6, -0.28, 0.735, 0.045) 0.2s;
        cursor: pointer;
    }

    .visibledetails:hover .active {
        background-color: #444;
        transition: none;
        cursor: pointer;
    }

    .hiddendetails .active {
        background-color: #444;
        display: block;
        transition: cubic-bezier(0.075, 0.82, 0.165, 1) 0.5s;
    }

    #mapdiv {
        position: relative;
        width: 100%;
        height: 500px;
        border-color: #fff;
        background-color: #fff;
    }
</style>
{% endblock %}
{% block main %}
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD_JtvDeZqiy9sxCKqfggODYMhuaeeLjXI&callback=initMap"
    async="false"></script>

<button id="submit">Submit</button>
<h1 class="style1"> Route 1 </h1>
<div id="mapdiv"></div>
<!--- This is where the map will be rendered-->
<div id="detailsdiv">
    {% for carpool in generated_carpools %}
    <div id="carpool{{carpool.id}}">
        <div class="visibledetails details{{carpool.id}}" onclick="renderMap(event, '{{carpool.id}}')">
            This is a place that the people where the place.
        </div>
        <div class="hiddendetails details{{carpool.id}}">
        </div>
    </div>
    {% endfor %}
    <div id="Richmond">
        <div class="visibledetails details0" onclick="renderMap(event, '0')">
            <p class="style2">Hi!</p>
        </div>
        <div class="hiddendetails">
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}

<script>
    console.log("starting script");
    var map = "";
    let rendered_carpool;


    window.initMap = initMap


    function initMap() {
        var directionsService = new google.maps.DirectionsService();
        var directionsRenderer = new google.maps.DirectionsRenderer();
        map = new google.maps.Map(document.getElementById("mapdiv"), {
            zoom: 6,
            center: { lat: 41.85, lng: -87.65 },
        });
        directionsRenderer.setMap(map);
        document.getElementById("submit").addEventListener("click", () => {
            calculateAndDisplayRoute(directionsService, directionsRenderer);
        });
        console.log("map initialized");
    }

    function calculateAndDisplayRoute(directionsService, directionsRenderer) {
        //const waypts = [];
        //const checkboxArray = document.getElementById("waypoints");
        //
        //for (let i = 0; i < checkboxArray.length; i++) {
        //    if (checkboxArray.options[i].selected) {
        //        waypts.push({
        //            location: checkboxArray[i].value,
        //            stopover: true,
        //        });
        //    }
        //}


        directionsService
            .route({
                origin: 'Richmond, VA',
                destination: 'Chicago, IL',
                //waypoints: waypts,
                //optimizeWaypoints: true,
                travelMode: google.maps.TravelMode.DRIVING,
            })
            .then((response) => {
                directionsRenderer.setDirections(response);
                console.log('test request successful');

                const route = response.routes[0];
                //const summaryPanel = document.getElementById("directions-panel");
                //
                //summaryPanel.innerHTML = "";
                //
                //// For each route, display summary information.
                //for (let i = 0; i < route.legs.length; i++) {
                //    const routeSegment = i + 1;
                //
                //    summaryPanel.innerHTML +=
                //        "<b>Route Segment: " + routeSegment + "</b><br>";
                //    summaryPanel.innerHTML += route.legs[i].start_address + " to ";
                //    summaryPanel.innerHTML += route.legs[i].end_address + "<br>";
                //    summaryPanel.innerHTML += route.legs[i].distance.text + "<br><br>";
                //}
            })
            .catch((e) => window.alert("Directions request failed due to " + status + e));
    }

    function renderMap(event, carpool_id) {

        //toggling the visibility
        const detailsdiv = document.getElementById(carpool_id);
        const hiddendetails = detailsdiv.getElementsByClassName("details" + carpool_id)[0];
        const visibledetails = detailsdiv.getElementsByClassName("details" + carpool_id)[1];
        if (hiddendetails.classList.contains("active")) {
            hiddendetails.classList.remove("active");
            visibledetails.classList.add("active");
        } else {
            hiddendetails.classList.add("active");
            visibledetails.classList.remove("active");
        }

        // getting data for map
        let http_request = new XMLHttpRequest();
        var directionsService = new google.maps.DirectionsService();
        var directionsRenderer = new google.maps.DirectionsRenderer();
        directionsRenderer.setMap(map)
        http_request.open("GET", "{{url_for('internal.get_generated_carpool_data', carpool_id='CHANGETHIS')}}".replace('CHANGETHIS', carpool_id), true);
        http_request.send();
        http_request.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                let data = JSON.parse(this.responseText);
                console.log(data);

                directionsService
                    .route({
                        origin: data.origin,
                        destination: data.destination,
                        waypoints: data.waypoints,
                        optimizeWaypoints: false,
                        travelMode: google.maps.TravelMode.DRIVING,
                    })
                    .then((response) => {
                        directionsRenderer.setDirections(response);
                        console.log('request was successful for map render')
                        const route = response.routes[0];


                    })
                //const summaryPanel = document.getElementById("directions-panel");

                rendered_carpool = carpool_id; // this is the carpool that is currently rendered
            }

            //function render_map() {
            //    const mapdiv = document.getElementById("mapdiv");
            //    const map = new google.maps.Map(mapdiv, {
            //        zoom: 6,
            //        center: { lat: 41.85, lng: -87.65 },
            //    });
            //    directionsRenderer.setMap(map);
            //}


            //window.initMap = initMap;
        }
    }

</script>


{% endblock %}